var token,host,localUsername,ice,pcs={},localStream;$(document).ready(function(){$.ajax({url:'https://global.xirsys.net/_turn/MyFirstApp/',type:'PUT',contentType:'text/plain',xhrFields:{withCredentials:!1},headers:{Authorization:'Basic '+btoa('ARandomUsername123:e72a0a98-f13e-11e7-9ec5-117660593455')},success:function(a){onIce(a)},error:function(){}})});function onIce(a){ice=a.v;var b;b=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?{audio:!0,video:{mandatory:{maxWidth:480,maxHeight:320}}}:{audio:!0,video:{width:1280,height:720}},navigator.mediaDevices.getUserMedia(b).then(c=>onGetMedia(c)).catch(function(c){console.log(c)})}function onGetMedia(a){var b=document.getElementById('localVideo');b.srcObject=a,localStream=a}function displayMessage(a){document.getElementById('messages').value+=a+'\n'}function connect(){localUsername=document.getElementById('username').value,$.ajax({url:'https://global.xirsys.net/_token/MyFirstApp?k='+localUsername,type:'PUT',contentType:'text/plain',xhrFields:{withCredentials:!1},headers:{Authorization:'Basic '+btoa('ARandomUsername123:e72a0a98-f13e-11e7-9ec5-117660593455')},success:function(a){token=a.v,getHost(token)},error:function(){}})}function getHost(){$.ajax({url:'https://global.xirsys.net/_host/MyFirstApp?type=signal&k='+localUsername,type:'GET',contentType:'text/plain',xhrFields:{withCredentials:!1},headers:{Authorization:'Basic '+btoa('ARandomUsername123:e72a0a98-f13e-11e7-9ec5-117660593455')},success:function(b){host=b.v,openSocket(host)},error:function(){}})}function openSocket(a){socket=new WebSocket(a+'/v2/'+token),socket.addEventListener('message',onSocketMessage)}function onSocketMessage(a){var b=JSON.parse(a.data),e;switch(b.m.o){case'peers':var g=b.p.users;for(i=0;i<g.length;i++)displayMessage('User in chat:'+g[i]);break;case'peer_connected':var h=b.m.f.split('/'),j=h[h.length-1];displayMessage('New user joined:'+j),callPeer(j);break;case'message':switch(b.p.msg.type){case'offer':var k=new RTCSessionDescription(b.p.msg),h=b.m.f.split('/'),l=h[h.length-1];e=createNewPeerConnection(l),e.setRemoteDescription(k),e.createAnswer().then(n=>onCreateAnswer(n,l));break;case'answer':var k=new RTCSessionDescription(b.p.msg),h=b.m.f.split('/'),l=h[h.length-1];pcs[l].pc.setRemoteDescription(k);break;case'candidate':var h=b.m.f.split('/'),l=h[h.length-1],m=new RTCIceCandidate(b.p.msg);pcs[l].pc.addIceCandidate(m);}}}function callPeer(a){var b=createNewPeerConnection(a),c=b.createDataChannel('data');pcs[a].dc=c,setDataChannelHandlers(c),b.createOffer().then(e=>onCreateOffer(e,a))}function setDataChannelHandlers(a){a.onmessage=b=>onDataMessage(b),a.onopen=b=>onDataChannelOpen(b)}function onDataChannelOpen(){$('#newMessage').disabled=!1,$('#sendButton').disabled=!1}function onDataChannel(a){for(var e,b=a.channel,c=Object.keys(pcs),j=0;j<c.length;j++)e=pcs[c[j]],a.currentTarget.localDescription.sdp==e.pc.localDescription.sdp&&(e.dc=b);setDataChannelHandlers(b)}function send(){var a=$('#newMessage')[0];displayMessage('you said: '+a.value);var b={f:localUsername,msg:a.value};a.value='';for(var c,g,e=Object.keys(pcs),h=0;h<e.length;h++)g=pcs[e[h]],c=g.dc,c.send(JSON.stringify(b))}function createNewPeerConnection(a){var b=new RTCPeerConnection(ice);return b.addStream(localStream),b.onaddstream=c=>onAddStream(c),b.ondatachannel=c=>onDataChannel(c),b.onicecandidate=c=>onIceCandidate(c),pcs[a]={pc:b,dc:null,s:null,v:null},b}function onAddStream(a){var b=a.target,c=a.stream,e=getUsernameByRemoteDescription(b.remoteDescription.sdp);pcs[e].s=c;var g=addNewVideo(c);pcs[e].v=g}function addNewVideo(a){var b=document.createElement('video');return b.autoplay=!0,document.getElementById('videoDiv').appendChild(b),b.srcObject=a,b}function getUsernameByRemoteDescription(a){for(var c,b=Object.keys(pcs),e=0;e<b.length;e++)if(c=pcs[b[e]].pc,c.remoteDescription.sdp==a)return b[e];return null}function onDataMessage(a){var b=JSON.parse(a.data);displayMessage(b.f+' said: '+b.msg)}function onCreateOffer(a,b){pcs[b].pc.setLocalDescription(a);var c={t:'u',m:{f:'MyFirstApp/'+localUsername,o:'message',t:b},p:{msg:a}};socket.send(JSON.stringify(c))}function onCreateAnswer(a,b){pcs[b].pc.setLocalDescription(a);var c={t:'u',m:{f:'MyFirstApp/'+localUsername,o:'message',t:b},p:{msg:a}};socket.send(JSON.stringify(c))}function onIceCandidate(a){var b=getUsernameByRemoteDescription(a.target.remoteDescription.sdp),c=a.candidate;if(null!=c&&null!=b){var e={type:'candidate',sdpMLineIndex:c.sdpMLineIndex,sdpMid:c.sdpMid,candidate:c.candidate},g={t:'u',m:{f:'MyFirstApp/'+localUsername,o:'message',t:b},p:{msg:e}};socket.send(JSON.stringify(g))}}
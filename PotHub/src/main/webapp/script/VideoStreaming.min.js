var token,host,localUsername,ice,pcs={},localStream;$(document).ready(function(){$.ajax({url:'https://global.xirsys.net/_turn/MyFirstApp/',type:'PUT',contentType:'text/plain',xhrFields:{withCredentials:!1},headers:{Authorization:'Basic '+btoa('ARandomUsername123:e72a0a98-f13e-11e7-9ec5-117660593455')},success:function(a){onIce(a)},error:function(){}})});function onIce(a){ice=a.v;var b;b=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)?{audio:!0,video:{mandatory:{maxWidth:480,maxHeight:320}}}:{audio:!0,video:{width:1280,height:720}},navigator.mediaDevices.getUserMedia(b).then(c=>onGetMedia(c)).catch(function(c){console.log(c)})}function onGetMedia(a){var b=document.getElementById('localVideo');b.srcObject=a,localStream=a,b.onloadedmetadata=function(){video.play()}}function displayMessage(a){document.getElementById('messages').value+=a+'\n'}function connect(){localUsername=document.getElementById('username').value,$.ajax({url:'https://global.xirsys.net/_token/MyFirstApp?k='+localUsername,type:'PUT',contentType:'text/plain',xhrFields:{withCredentials:!1},headers:{Authorization:'Basic '+btoa('ARandomUsername123:e72a0a98-f13e-11e7-9ec5-117660593455')},success:function(a){token=a.v,getHost(token)},error:function(){}})}function getHost(){$.ajax({url:'https://global.xirsys.net/_host/MyFirstApp?type=signal&k='+localUsername,type:'GET',contentType:'text/plain',xhrFields:{withCredentials:!1},headers:{Authorization:'Basic '+btoa('ARandomUsername123:e72a0a98-f13e-11e7-9ec5-117660593455')},success:function(b){host=b.v,openSocket(host)},error:function(){}})}function openSocket(a){socket=new WebSocket(a+'/v2/'+token),socket.addEventListener('message',onSocketMessage)}function onSocketMessage(a){var b=JSON.parse(a.data),g;switch(b.m.o){case'peers':var h=b.p.users;for(i=0;i<h.length;i++)displayMessage('User in chat:'+h[i]);break;case'peer_connected':var k=b.m.f.split('/'),l=k[k.length-1];displayMessage('New user joined:'+l),callPeer(l);break;case'message':switch(b.p.msg.type){case'offer':var m=new RTCSessionDescription(b.p.msg),k=b.m.f.split('/'),n=k[k.length-1];g=createNewPeerConnection(n),g.setRemoteDescription(m),g.createAnswer().then(p=>onCreateAnswer(p,n));break;case'answer':var m=new RTCSessionDescription(b.p.msg),k=b.m.f.split('/'),n=k[k.length-1];pcs[n].pc.setRemoteDescription(m);break;case'candidate':var k=b.m.f.split('/'),n=k[k.length-1],o=new RTCIceCandidate(b.p.msg);pcs[n].pc.addIceCandidate(o);}}}function callPeer(a){var b=createNewPeerConnection(a),c=b.createDataChannel('data');pcs[a].dc=c,setDataChannelHandlers(c),b.createOffer().then(g=>onCreateOffer(g,a))}function setDataChannelHandlers(a){a.onmessage=b=>onDataMessage(b),a.onopen=b=>onDataChannelOpen(b)}function onDataChannelOpen(){$('#newMessage').disabled=!1,$('#sendButton').disabled=!1}function onDataChannel(a){for(var g,b=a.channel,c=Object.keys(pcs),l=0;l<c.length;l++)g=pcs[c[l]],a.currentTarget.localDescription.sdp==g.pc.localDescription.sdp&&(g.dc=b);setDataChannelHandlers(b)}function send(){var a=$('#newMessage')[0];displayMessage('you said: '+a.value);var b={f:localUsername,msg:a.value};a.value='';for(var c,h,g=Object.keys(pcs),k=0;k<g.length;k++)h=pcs[g[k]],c=h.dc,c.send(JSON.stringify(b))}function createNewPeerConnection(a){var b=new RTCPeerConnection(ice);return b.addStream(localStream),b.onaddstream=c=>onAddStream(c),b.ondatachannel=c=>onDataChannel(c),b.onicecandidate=c=>onIceCandidate(c),pcs[a]={pc:b,dc:null,s:null,v:null},b}function onAddStream(a){var b=a.target,c=a.stream,g=getUsernameByRemoteDescription(b.remoteDescription.sdp);pcs[g].s=c;var h=addNewVideo(c);pcs[g].v=h}function addNewVideo(a){var b=document.createElement('video');return b.autoplay=!0,document.getElementById('videoDiv').appendChild(b),b.srcObject=a,b}function getUsernameByRemoteDescription(a){for(var c,b=Object.keys(pcs),g=0;g<b.length;g++)if(c=pcs[b[g]].pc,c.remoteDescription.sdp==a)return b[g];return null}function onDataMessage(a){var b=JSON.parse(a.data);displayMessage(b.f+' said: '+b.msg)}function onCreateOffer(a,b){a.sdp=setVideoCodec(a.sdp),pcs[b].pc.setLocalDescription(a);var c={t:'u',m:{f:'MyFirstApp/'+localUsername,o:'message',t:b},p:{msg:a}};socket.send(JSON.stringify(c))}function onCreateAnswer(a,b){a.sdp=setVideoCodec(a.sdp),pcs[b].pc.setLocalDescription(a);var c={t:'u',m:{f:'MyFirstApp/'+localUsername,o:'message',t:b},p:{msg:a}};socket.send(JSON.stringify(c))}function onIceCandidate(a){var b=getUsernameByRemoteDescription(a.target.remoteDescription.sdp),c=a.candidate;if(null!=c&&null!=b){var g={type:'candidate',sdpMLineIndex:c.sdpMLineIndex,sdpMid:c.sdpMid,candidate:c.candidate},h={t:'u',m:{f:'MyFirstApp/'+localUsername,o:'message',t:b},p:{msg:g}};socket.send(JSON.stringify(h))}}function setVideoCodec(a){for(var c,b=a.split('\r\n'),g=0;g<b.length;g++)if(-1!==b[g].search('m=video')){c=g;break}if(null===c)return a;for(var h=[],g=c;g<b.length;g++)if(-1!==b[g].search('a=rtpmap')){var k=b[g].split(' ');if('H264'!==k[1].substr(0,4))b.splice(g,1);else{var l=[k[0].substr(9)];h=h.concat(l)}}for(var g=c;g<b.length;g++)if(-1!==b[g].search('a=rtcp-fb')){for(var k=b[g].split(' '),m=!0,n=0;n<h.length;n++)k[0].substr(10)===h[n]&&(m=!1);m&&b.splice(g,5)}for(var g=c;g<b.length;g++)if(-1!==b[g].search('a=fmtp')){for(var k=b[g].split(' '),m=!0,n=0;n<h.length;n++)k[0].substr(7)===h[n]&&(m=!1);m&&b.splice(g,1)}var o=b[c].split(' '),p=[o[0],o[1],o[2]];return o=p.concat(h),b[c]=o.join(' '),a=b.join('\r\n'),a}